<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Querying rolled up measurements • openaq</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Querying rolled up measurements">
<script defer data-domain="openaq.github.io/openaq-r" src="https://plausible.io/js/script.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">openaq</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/openaq.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/geospatial-queries.html">geospatial-queries</a></li>
    <li><a class="dropdown-item" href="../articles/plotting.html">plotting</a></li>
    <li><a class="dropdown-item" href="../articles/querying-measurements.html">querying-measurements</a></li>
    <li><a class="dropdown-item" href="../articles/querying-rollups.html">Querying rolled up measurements</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://join.slack.com/t/openaq/shared_invite/zt-yzqlgsva-v6McumTjy2BZnegIK9XCVw" aria-label="Slack"><span class="fa fa-slack"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openaq/openaq-r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Querying rolled up measurements</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openaq/openaq-r/blob/main/vignettes/querying-rollups.Rmd" class="external-link"><code>vignettes/querying-rollups.Rmd</code></a></small>
      <div class="d-none name"><code>querying-rollups.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/openaq/openaq-r" class="external-link">openaq</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>The OpenAQ API has the ability to provide measurement in the original
reported time period as well as aggregated to larger time periods.
<code>openaq</code> provides methods to access these various periods of
data, and includes additional descriptive statistics and coverage
information.</p>
<p>Many public health standards rely on daily or yearly means so having
access to these values precomputed allows for easier access and
comparison. The World Health Organization (WHO) sets the daily
PM<sub>2.5</sub> guideline to 15 µg/m³.</p>
<p>This vignette will demonstrate how to query data using
<code>openaq</code> and get results to compare against public health
benchmarks like the WHO daily PM<sub>2.5</sub> standard.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set_api_key.html">set_api_key</a></span><span class="op">(</span><span class="st">"replace-me-with-a-valid-openaq-api-key"</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/list_sensor_measurements.html">list_sensor_measurements()</a></code> function provides
precomputed aggregations through the data argument. This arugment
defaults to <code>measurements</code> or the original measurement
period. The full list of options includes: <code>measurements</code>,
<code>hours</code>, <code>days</code>, <code>years</code>. As an example
we will query PM<sub>2.5</sub> data from sensor <code>3646869</code>,
from the ‘Mari - Industrial Station’ location in the Republic of Cyprus.
To compare against the WHO daily guideline, we will request data
aggregated to the day, using the <code>days</code> option:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/list_sensor_measurements.html">list_sensor_measurements</a></span><span class="op">(</span></span>
<span>  <span class="fl">3646869</span>,</span>
<span>  data <span class="op">=</span> <span class="st">"days"</span>,</span>
<span>  datetime_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2025-01-01"</span>, tz <span class="op">=</span> <span class="st">"Asia/Nicosia"</span><span class="op">)</span>,</span>
<span>  datetime_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2025-05-31"</span>, tz <span class="op">=</span> <span class="st">"Asia/Nicosia"</span><span class="op">)</span>,</span>
<span>  limit <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The measurements resource provides coverage information when
aggregating data into time periods. This helps provide transparency into
the data coverage and help us decide if the resulting mean is
representative. This completeness is computed based on the result of
dividing <code>observed_count</code> by <code>expected_count</code>, in
the case of a <code>days</code> average and hourly measurement, we
expect 24 measurements to be the complete period.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"value"</span>, <span class="st">"percent_complete"</span>, <span class="st">"expected_count"</span>, <span class="st">"observed_count"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   value percent_complete expected_count observed_count</span></span>
<span><span class="co">#&gt; 1  19.0              100             24             24</span></span>
<span><span class="co">#&gt; 2  18.5              100             24             24</span></span>
<span><span class="co">#&gt; 3  18.4              100             24             24</span></span>
<span><span class="co">#&gt; 4  17.2              100             24             24</span></span>
<span><span class="co">#&gt; 5  27.7              100             24             24</span></span>
<span><span class="co">#&gt; 6  20.0              100             24             24</span></span></code></pre></div>
<p>We can filter out values by accessing the
<code>percent_complete</code> field. A commonly used threshold for data
completeness is 75%, in the case of a daily average at least 18 out of
24 hours.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">percent_complete</span> <span class="op">&gt;</span> <span class="fl">75</span>, <span class="op">]</span></span></code></pre></div>
<p>We can now plot the daily average time series and compare it against
the WHO daily threshold value with <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">datetime_to</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">15</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Daily PM"</span><span class="op">[</span><span class="fl">2.5</span><span class="op">]</span><span class="op">~</span><span class="st">"average values"</span><span class="op">)</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Jan-May 2025 with WHO daily threshold"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"PM"</span><span class="op">[</span><span class="fl">2.5</span><span class="op">]</span><span class="op">~</span><span class="st">"Concentration ("</span><span class="op">*</span><span class="va">mu</span><span class="op">*</span><span class="st">"g/m"</span><span class="op">^</span><span class="fl">3</span><span class="op">*</span><span class="st">")"</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">expand_limits</span><span class="op">(</span>y <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/who-daily-avg-plot-1.png" alt="plot of chunk who-daily-avg-plot"><div class="figcaption">plot of chunk who-daily-avg-plot</div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russ Biggs, Christian Parker, OpenAQ.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
